@model Models.VendorModel
@using Models

@{
    var categories = ViewBag.Categories as IEnumerable<CategoryModel>
                     ?? new List<CategoryModel>();
    var selectedCategories = ViewBag.SelectedCategories as IEnumerable<VendorCategoryModel>
           ?? new List<VendorCategoryModel>();
}

<div class="card">
    <div class="card-header">
        <h5>Edit Profil Vendor</h5>
    </div>

    <div class="card-body">
        <form asp-action="Edit" method="post">
            <input type="hidden" asp-for="VendorId" />
            <input type="hidden" asp-for="UserId" />

            <div class="mb-3">
                <label>Nama Perusahaan</label>
                <input asp-for="CompanyName" class="form-control" required />
            </div>

            <div class="mb-3">
                <label>Email</label>
                <input value="@Model.Email"
                       class="form-control"
                       disabled />
            </div>

            <div class="mb-3">
                <label class="form-label" for="basic-default-fullname">Nomor handphone</label>
                <br />
                <label class="form-label">contoh 6289603098131</label>
                <input type="text"
                       asp-for="PhoneNumber"
                       id="phoneInput"
                       class="form-control"
                       placeholder="Nomor Handphone"
                       required
                       pattern="^[1-9][0-9]*$"
                       value="@Model.PhoneNumber"
                       title="Nomor HP tidak boleh diawali angka 0" />

                <span asp-validation-for="PhoneNumber" class="text-danger"></span>



            </div>


            <div class="mb-3">
                <label>Alamat</label>
                <input asp-for="Address" class="form-control" required />
            </div>
            <div class="mb-3">
                <label>Pilih Kategory</label>
                <div class="input-group mb-2">
                    <select id="categorySelect" class="form-select">
                        <option value="">-- Pilih Kategori --</option>
                        @foreach (var cat in categories)
                        {
                            <option value="@cat.CategoryId">@cat.CategoryName</option>
                        }
                    </select>

                    <button type="button" class="btn btn-primary" onclick="addCategory()">
                        Add
                    </button>
                </div>
            </div>



            <!-- tempat badge -->
            <div id="selectedCategories" class="d-flex flex-wrap gap-2"></div>

            <!-- HIDDEN INPUT (INI PENTING) -->
            <div id="hiddenInputs"></div>

            <div class="d-flex justify-content-end gap-2">
                <a asp-action="Index" class="btn btn-secondary">Kembali</a>
                <button class="btn btn-success">Simpan</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        const selected = new Map(); // id -> name

        // preload (untuk EDIT)
        @foreach (var c in selectedCategories)
        {
                <text>
                    selected.set("@c.CategoryId", "@c.CategoryName");
                </text>
        }


        function addCategory() {
            const select = document.getElementById("categorySelect");
            const id = select.value;
            const name = select.options[select.selectedIndex].text;

            if (!id || selected.has(id)) return;

            selected.set(id, name);
            render();
        }

        function removeCategory(id) {
            selected.delete(id);
            render();
        }

        function render() {
            const badgeContainer = document.getElementById("selectedCategories");
            const hiddenContainer = document.getElementById("hiddenInputs");

            badgeContainer.innerHTML = "";
            hiddenContainer.innerHTML = "";

            selected.forEach((name, id) => {
                // badge
                const badge = document.createElement("span");
                badge.className = "badge bg-primary d-flex align-items-center gap-1 mb-4";
                badge.innerHTML = `
                    ${name}
                    <button type="button" class="btn-close btn-close-white btn-sm"
                            onclick="removeCategory('${id}')"></button>
                `;
                badgeContainer.appendChild(badge);

                // hidden input (MODEL BINDING)
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "SelectedCategoryIds";
                input.value = id;
                hiddenContainer.appendChild(input);
            });
        }

                document.addEventListener("DOMContentLoaded", function () {
            render();
        });


        // nomer telepon
                const phoneInput = document.getElementById("phoneInput");

        phoneInput.addEventListener("input", function () {
            this.value = this.value.replace(/\D/g, "");

            if (this.value.startsWith("0")) {
                this.value = this.value.substring(1);
            }
        });
    </script>

}
